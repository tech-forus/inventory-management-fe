import{d as q,u as P,r as x,j as e}from"./index-v4UyLoar.js";import{a as j,f as v}from"./formatters-ptPrPoGe.js";import{i as L}from"./inventoryService-3mhiX-ga.js";import{s as F}from"./skuService-CD47JNeC.js";import{A as V}from"./arrow-left-CQGXFyIF.js";import{L as z}from"./loader-2-BkVOmpJm.js";import"./api-VNhYhLPD.js";import"./cachedApi-CKq13PPM.js";const ee=()=>{const{id:u}=q(),I=P(),[Q,b]=x.useState(!0),[h,k]=x.useState([]),[C,y]=x.useState(null),[D,K]=x.useState(""),[A,R]=x.useState("");x.useEffect(()=>{u&&S()},[u]);const S=async()=>{var s,g;if(u)try{b(!0),y(null);const r=await F.getById(parseInt(u));if(r.success&&r.data){const f=r.data,p=f.skuId||f.sku_id||"",_=f.itemName||f.item_name||"";if(K(_),R(p),!p){y("SKU Code not found for this item"),b(!1);return}const w=await L.getIncomingHistory({sku:p});if(w.success&&w.data){const $=w.data,T=[],E=10;for(let i=0;i<$.length;i+=E){const m=$.slice(i,i+E).map(async a=>{try{const l=await L.getIncomingById(a.id);if(l.success&&l.data.items){const t=l.data.items.find(n=>(n.skuCode||n.sku_code||n.skuId||n.sku_id)===p);if(t){const n=t.updatedAt||t.updated_at||a.updatedAt||a.updated_at,d=t.itemId||t.item_id||t.id||0;return{id:a.id,itemId:d,invoiceNumber:a.invoiceNumber||a.invoice_number||"",invoiceDate:a.invoiceDate||a.invoice_date||"",receivingDate:a.receivingDate||a.receiving_date||"",itemName:t.itemName||t.item_name||_||"",skuId:t.skuId||t.sku_id,skuCode:t.skuCode||t.sku_code||p,vendorName:a.vendorName||a.vendor_name||"",totalQuantity:t.totalQuantity||t.total_quantity||0,received:t.received||0,rejected:t.rejected||0,short:t.short||0,challanNumber:t.challanNumber||t.challan_number,challanDate:t.challanDate||t.challan_date,updatedAt:n,uniqueKey:""}}}}catch(l){console.error(`Error loading details for record ${a.id}:`,l)}return null}),o=await Promise.all(m);T.push(...o.filter(a=>a!==null))}const N=[...h],U=Date.now();let B=0;T.forEach((i,c)=>{const m=`${i.id}-${i.itemId}`,o=N.filter(t=>`${t.id}-${t.itemId}`===m),a=o.length>0?o.sort((t,n)=>{const d=t.updatedAt?new Date(t.updatedAt).getTime():0;return(n.updatedAt?new Date(n.updatedAt).getTime():0)-d})[0]:null;let l=!1;if(!a)l=!0;else{const t=a.rejected!==i.rejected,n=a.short!==i.short,d=a.received!==i.received,H=a.totalQuantity!==i.totalQuantity;l=t||n||d||H}if(l){B++;const t=Math.random().toString(36).substr(2,9),n=performance.now(),d={...i,uniqueKey:`fetch-${U}-${n}-${B}-${c}-${i.id}-${i.itemId}-${t}`};N.push(d)}}),N.sort((i,c)=>{const m=i.updatedAt?new Date(i.updatedAt).getTime():0,o=c.updatedAt?new Date(c.updatedAt).getTime():0;if(o!==m)return o-m;const a=new Date(i.receivingDate).getTime(),l=new Date(c.receivingDate).getTime();return l!==a?l-a:i.invoiceNumber.localeCompare(c.invoiceNumber)}),k(N)}else k([])}else y("Item not found")}catch(r){console.error("Error loading item history:",r),y(((g=(s=r.response)==null?void 0:s.data)==null?void 0:g.error)||r.message||"Failed to load item history"),k([])}finally{b(!1)}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>I("/app/inventory"),className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",title:"Back to Inventory",children:e.jsx(V,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Item History"}),D&&A&&e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[D," - ",A]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:Q?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(z,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading history..."})]}):C?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:C}),e.jsx("button",{onClick:S,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Retry"})]}):h.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No history found for this item"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Invoice/Challan Number"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Invoice/Challan Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Receiving Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Item Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"SKU ID"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Total Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Received"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Rejected"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Short"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Last Updated / Change Time"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:h.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-gray-900 font-medium",children:e.jsxs("div",{children:[e.jsx("button",{onClick:()=>{const g=encodeURIComponent(s.invoiceNumber||""),r=encodeURIComponent(s.skuCode||s.skuId||"");I(`/app/invoice/${g}/${r}/history`)},className:"font-semibold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer text-left",title:"Click to view all changes for this invoice",children:s.invoiceNumber||"-"}),s.challanNumber&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Challan: ",s.challanNumber]})]})}),e.jsx("td",{className:"px-4 py-3 text-gray-700",children:e.jsxs("div",{children:[e.jsx("div",{children:j(s.invoiceDate)}),s.challanDate&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Challan: ",j(s.challanDate)]})]})}),e.jsx("td",{className:"px-4 py-3 text-gray-700",children:j(s.receivingDate)}),e.jsx("td",{className:"px-4 py-3 text-gray-700",children:s.itemName}),e.jsx("td",{className:"px-4 py-3 text-gray-700 font-mono text-xs",children:s.skuCode||s.skuId||"-"}),e.jsx("td",{className:"px-4 py-3 text-gray-700",children:s.vendorName}),e.jsx("td",{className:"px-4 py-3 text-gray-900 font-semibold",children:v(s.totalQuantity)}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-green-700 font-semibold",children:v(s.received)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-red-700 font-semibold",children:v(s.rejected)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"text-orange-700 font-semibold",children:v(s.short)})}),e.jsx("td",{className:"px-4 py-3 text-gray-500 text-xs",children:s.updatedAt?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:j(s.updatedAt)}),e.jsx("div",{className:"text-gray-400 text-xs",children:new Date(s.updatedAt).toLocaleTimeString()})]}):"-"})]},s.uniqueKey))})]})})}),h.length>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Records: ",e.jsx("span",{className:"font-semibold",children:h.length})]})]})};export{ee as default};
