import{d as J,u as M,r as m,j as e}from"./index-v4UyLoar.js";import{a as f,f as j}from"./formatters-ptPrPoGe.js";import{i as L}from"./inventoryService-3mhiX-ga.js";import{A as O}from"./arrow-left-CQGXFyIF.js";import{L as G}from"./loader-2-BkVOmpJm.js";import"./api-VNhYhLPD.js";import"./cachedApi-CKq13PPM.js";function r(s){return s??""}function q(s){return JSON.stringify({invoiceNumber:r(s.invoiceNumber),totalQuantity:r(s.totalQuantity),received:r(s.received),rejected:r(s.rejected),short:r(s.short),challanNumber:r(s.challanNumber),challanDate:r(s.challanDate),invoiceDate:r(s.invoiceDate),receivingDate:r(s.receivingDate),vendorName:r(s.vendorName),itemName:r(s.itemName),skuCode:r(s.skuCode),skuId:r(s.skuId),updatedAt:r(s.updatedAt)})}const ae=()=>{const{invoiceNumber:s,skuCode:y}=J(),P=M(),[Q,A]=m.useState(!0),[d,b]=m.useState([]),[C,S]=m.useState(null),[$,U]=m.useState(""),[_,B]=m.useState(""),[w,F]=m.useState("");m.useEffect(()=>{if(s&&y){k();const n=setInterval(()=>{k()},3e3);return()=>{n&&clearInterval(n)}}},[s,y]);const k=async()=>{var n,g;if(!(!s||!y))try{A(!0),S(null);const x=decodeURIComponent(s),N=decodeURIComponent(y);U(x),B(N);const D=await L.getIncomingHistory({sku:N});if(D.success&&D.data){const T=D.data,E=[],H=10;for(let i=0;i<T.length;i+=H){const h=T.slice(i,i+H).map(async a=>{try{const l=await L.getIncomingById(a.id);if(l.success&&l.data.items){const t=l.data.items.find(c=>(c.skuCode||c.sku_code||c.skuId||c.sku_id)===N);if(t&&(a.invoiceNumber||a.invoice_number)===x){const c=t.updatedAt||t.updated_at||a.updatedAt||a.updated_at,o=t.itemId||t.item_id||t.id||0,I=c?new Date(c).getTime():Date.now(),z=`${a.id}-${o}-${I}-${Math.random().toString(36).substr(2,9)}`,K=t.itemName||t.item_name||"";return w||F(K),{id:a.id,itemId:o,invoiceNumber:a.invoiceNumber||a.invoice_number||"",invoiceDate:a.invoiceDate||a.invoice_date||"",receivingDate:a.receivingDate||a.receiving_date||"",itemName:K,skuId:t.skuId||t.sku_id,skuCode:t.skuCode||t.sku_code||N,vendorName:a.vendorName||a.vendor_name||"",totalQuantity:t.totalQuantity||t.total_quantity||0,received:t.received||0,rejected:t.rejected||0,short:t.short||0,challanNumber:t.challanNumber||t.challan_number,challanDate:t.challanDate||t.challan_date,updatedAt:c,uniqueKey:z}}}}catch(l){console.error(`Error loading details for record ${a.id}:`,l)}return null}),p=await Promise.all(h);E.push(...p.filter(a=>a!==null))}const v=structuredClone(d),V=Date.now();let R=0;E.forEach((i,u)=>{const h=`${i.id}-${i.itemId}`,a=v.filter(t=>`${t.id}-${t.itemId}`===h).reduce((t,c)=>{const o=c.updatedAt?new Date(c.updatedAt).getTime():0,I=t!=null&&t.updatedAt?new Date(t.updatedAt).getTime():0;return o>I?c:t},null);let l=!1;if(!a)l=!0;else{const t=q(a),c=q(i);t!==c&&(l=!0)}if(l){R++;const t=performance.now(),c=Date.now(),o={...i,uniqueKey:`invoice-${i.invoiceNumber}-${i.id}-${i.itemId}-${V}-${c}-${t}-${R}-${u}`};v.push(o)}}),v.sort((i,u)=>{const h=i.updatedAt?new Date(i.updatedAt).getTime():0,p=u.updatedAt?new Date(u.updatedAt).getTime():0;return p!==h?p-h:u.uniqueKey.localeCompare(i.uniqueKey)}),b(v)}else d.length===0&&b([])}catch(x){console.error("Error loading invoice history:",x),S(((g=(n=x.response)==null?void 0:n.data)==null?void 0:g.error)||x.message||"Failed to load invoice history"),d.length===0&&b([])}finally{A(!1)}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>P(-1),className:"p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",title:"Back",children:e.jsx(O,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Invoice History"}),$&&e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Invoice Number:"})," ",$]}),_&&e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"SKU ID:"})," ",_]}),w&&e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-semibold",children:"Item Name:"})," ",w]})]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:Q?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(G,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading invoice history..."})]}):C?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:C}),e.jsx("button",{onClick:k,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Retry"})]}):d.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No history found for this invoice"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider w-16",children:"S.No"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Invoice/Challan Date"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Receiving Date"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Total Quantity"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Received"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Rejected"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Short"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Last Updated / Change Time"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:d.map((n,g)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-center text-gray-700 font-semibold",children:g+1}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:e.jsxs("div",{children:[e.jsx("div",{children:f(n.invoiceDate)}),n.challanDate&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Challan: ",f(n.challanDate)]})]})}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:f(n.receivingDate)}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:n.vendorName}),e.jsx("td",{className:"px-4 py-3 text-gray-900 font-semibold text-center",children:j(n.totalQuantity)}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-green-700 font-semibold",children:j(n.received)})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-red-700 font-semibold",children:j(n.rejected)})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-orange-700 font-semibold",children:j(n.short)})}),e.jsx("td",{className:"px-4 py-3 text-gray-500 text-xs text-center",children:n.updatedAt?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:f(n.updatedAt)}),e.jsx("div",{className:"text-gray-400 text-xs",children:new Date(n.updatedAt).toLocaleTimeString()})]}):"-"})]},n.uniqueKey))})]})})}),d.length>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Records: ",e.jsx("span",{className:"font-semibold",children:d.length})]})]})};export{ae as default};
