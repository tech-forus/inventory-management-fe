import{d as J,u as M,r as m,j as e}from"./index-BNvq7L73.js";import{a as v,f as j}from"./formatters-ptPrPoGe.js";import{i as L}from"./inventoryService-B58imFTr.js";import{A as O}from"./arrow-left-BgDROCgl.js";import{L as G}from"./loader-2-R31GmkNV.js";import"./api-BJ7xcL-N.js";import"./cachedApi-DyAQX7TM.js";import"./inventoryEvents-fOALNsvn.js";function l(s){return s??""}function q(s){return JSON.stringify({invoiceNumber:l(s.invoiceNumber),totalQuantity:l(s.totalQuantity),received:l(s.received),rejected:l(s.rejected),short:l(s.short),challanNumber:l(s.challanNumber),challanDate:l(s.challanDate),invoiceDate:l(s.invoiceDate),receivingDate:l(s.receivingDate),vendorName:l(s.vendorName),itemName:l(s.itemName),skuCode:l(s.skuCode),skuId:l(s.skuId),updatedAt:l(s.updatedAt)})}const ne=()=>{const{invoiceNumber:s,skuCode:y}=J(),P=M(),[Q,A]=m.useState(!0),[o,b]=m.useState([]),[C,S]=m.useState(null),[$,U]=m.useState(""),[_,B]=m.useState(""),[k,F]=m.useState("");m.useEffect(()=>{if(s&&y){w();const n=setInterval(()=>{w()},3e3);return()=>{n&&clearInterval(n)}}},[s,y]);const w=async()=>{var n,N;if(!(!s||!y))try{A(!0),S(null);const x=decodeURIComponent(s),g=decodeURIComponent(y);U(x),B(g);const D=await L.getIncomingHistory({sku:g});if(D.success&&D.data){const T=D.data,E=[],H=10;for(let i=0;i<T.length;i+=H){const h=T.slice(i,i+H).map(async a=>{try{const r=await L.getIncomingById(a.id);if(r.success&&r.data.items){const t=r.data.items.find(c=>(c.skuCode||c.sku_code||c.skuId||c.sku_id)===g);if(t&&(a.invoiceNumber||a.invoice_number)===x){const c=t.updatedAt||t.updated_at||a.updatedAt||a.updated_at,d=t.itemId||t.item_id||t.id||0,I=c?new Date(c).getTime():Date.now(),z=`${a.id}-${d}-${I}-${Math.random().toString(36).substr(2,9)}`,K=t.itemName||t.item_name||"";return k||F(K),{id:a.id,itemId:d,invoiceNumber:a.invoiceNumber||a.invoice_number||"",invoiceDate:a.invoiceDate||a.invoice_date||"",receivingDate:a.receivingDate||a.receiving_date||"",itemName:K,skuId:t.skuId||t.sku_id,skuCode:t.skuCode||t.sku_code||g,vendorName:a.vendorName||a.vendor_name||"",totalQuantity:t.totalQuantity||t.total_quantity||0,received:t.received||0,rejected:t.rejected||0,short:t.short||0,challanNumber:t.challanNumber||t.challan_number,challanDate:t.challanDate||t.challan_date,updatedAt:c,uniqueKey:z}}}}catch(r){console.error(`Error loading details for record ${a.id}:`,r)}return null}),p=await Promise.all(h);E.push(...p.filter(a=>a!==null))}const f=structuredClone(o),V=Date.now();let R=0;E.forEach((i,u)=>{const h=`${i.id}-${i.itemId}`,a=f.filter(t=>`${t.id}-${t.itemId}`===h).reduce((t,c)=>{const d=c.updatedAt?new Date(c.updatedAt).getTime():0,I=t!=null&&t.updatedAt?new Date(t.updatedAt).getTime():0;return d>I?c:t},null);let r=!1;if(!a)r=!0;else{const t=q(a),c=q(i);t!==c&&(r=!0)}if(r){R++;const t=performance.now(),c=Date.now(),d={...i,uniqueKey:`invoice-${i.invoiceNumber}-${i.id}-${i.itemId}-${V}-${c}-${t}-${R}-${u}`};f.push(d)}}),f.sort((i,u)=>{const h=i.updatedAt?new Date(i.updatedAt).getTime():0,p=u.updatedAt?new Date(u.updatedAt).getTime():0;return p!==h?p-h:u.uniqueKey.localeCompare(i.uniqueKey)}),b(f)}else o.length===0&&b([])}catch(x){console.error("Error loading invoice history:",x),S(((N=(n=x.response)==null?void 0:n.data)==null?void 0:N.error)||x.message||"Failed to load invoice history"),o.length===0&&b([])}finally{A(!1)}};return e.jsxs("div",{className:"p-8 space-y-10 w-full animate-in fade-in slide-in-from-bottom-4 duration-500",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-6",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>P(-1),className:"text-slate-600 hover:text-slate-900 transition-colors",title:"Back",children:e.jsx(O,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-4xl font-black text-slate-900 tracking-tight",children:"Invoice History"})]}),$&&e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsxs("p",{className:"text-base text-slate-500 font-medium",children:[e.jsx("span",{className:"font-black text-slate-700",children:"Invoice Number:"})," ",$]}),_&&e.jsxs("p",{className:"text-base text-slate-500 font-medium",children:[e.jsx("span",{className:"font-black text-slate-700",children:"SKU ID:"})," ",e.jsx("span",{className:"font-mono text-indigo-600",children:_})]}),k&&e.jsxs("p",{className:"text-base text-slate-500 font-medium",children:[e.jsx("span",{className:"font-black text-slate-700",children:"Item Name:"})," ",k]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:Q?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(G,{className:"w-8 h-8 animate-spin text-blue-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Loading invoice history..."})]}):C?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-red-600 mb-4",children:C}),e.jsx("button",{onClick:w,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Retry"})]}):o.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-gray-500",children:"No history found for this invoice"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider w-16",children:"S.No"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Invoice/Challan Date"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Receiving Date"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Vendor"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Total Quantity"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Received"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Rejected"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Short"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold text-gray-700 uppercase tracking-wider",children:"Last Updated / Change Time"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:o.map((n,N)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-center text-gray-700 font-semibold",children:N+1}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:e.jsxs("div",{children:[e.jsx("div",{children:v(n.invoiceDate)}),n.challanDate&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Challan: ",v(n.challanDate)]})]})}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:v(n.receivingDate)}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-center",children:n.vendorName}),e.jsx("td",{className:"px-4 py-3 text-gray-900 font-semibold text-center",children:j(n.totalQuantity)}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-green-700 font-semibold",children:j(n.received)})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-red-700 font-semibold",children:j(n.rejected)})}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:"text-orange-700 font-semibold",children:j(n.short)})}),e.jsx("td",{className:"px-4 py-3 text-gray-500 text-xs text-center",children:n.updatedAt?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:v(n.updatedAt)}),e.jsx("div",{className:"text-gray-400 text-xs",children:new Date(n.updatedAt).toLocaleTimeString()})]}):"-"})]},n.uniqueKey))})]})})}),o.length>0&&e.jsxs("div",{className:"text-sm text-gray-600",children:["Total Records: ",e.jsx("span",{className:"font-semibold",children:o.length})]})]})};export{ne as default};
